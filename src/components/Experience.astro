---
import ExperienceItem from "./ExperienceItem.astro";
import { EXPERIENCE } from "@assets/const/experience";
import avion from "../assets/images/avion.webp";
import { Image } from "astro:assets";

// Tipos para los puntos
type Point = { x: number; y: number };
// Función para calcular un punto en una curva Bezier cúbica
function getCubicBezierXYatT(
  startPt: Point,
  controlPt1: Point,
  controlPt2: Point,
  endPt: Point,
  T: number
): Point {
  const x = Math.pow(1 - T, 3) * startPt.x
    + 3 * Math.pow(1 - T, 2) * T * controlPt1.x
    + 3 * (1 - T) * Math.pow(T, 2) * controlPt2.x
    + Math.pow(T, 3) * endPt.x;
  const y = Math.pow(1 - T, 3) * startPt.y
    + 3 * Math.pow(1 - T, 2) * T * controlPt1.y
    + 3 * (1 - T) * Math.pow(T, 2) * controlPt2.y
    + Math.pow(T, 3) * endPt.y;
  return { x, y };
}

// Definir los puntos de la curva (de acuerdo al path SVG)
const startPt: Point = { x: 0, y: 50 };
const controlPt1: Point = { x: 150, y: 0 };
const controlPt2: Point = { x: 450, y: 100 };
const endPt: Point = { x: 700, y: 50 };

const n: number = EXPERIENCE.length;
const flagPositions: Point[] = Array.from({ length: n }, (_, i) => {
  const t = (i + 1) / (n + 1);
  return getCubicBezierXYatT(startPt, controlPt1, controlPt2, endPt, t);
});
---

<div class="flex items-center" id="lineaExperience">
  <svg id="linea" class="absolute w-full -translate-x-64 translate-y-8" height="100" viewBox="0 0 700 100" xmlns="http://www.w3.org/2000/svg">
    <path id="curva" d="M 0 50 C 150 0, 450 100, 700 50" stroke="black" stroke-width="2" fill="transparent" />
    {flagPositions.map((pos, index) => (
        <g>
        <rect
          x={pos.x - 40}
          y={pos.y - 38}
          width="80"
          height="28"
          rx="7"
          fill={index % 2 === 0 ? '#31E981' : '#AE8ABC'}
          stroke="#222"
          stroke-width="2"
        />
        <text
          x={pos.x}
          y={pos.y - 24}
          text-anchor="middle"
          dominant-baseline="middle"
          fill="#082D0F"
          font-size="13"
          font-family="inherit"
        >
          {EXPERIENCE[index].company}
        </text>
        <circle
          cx={pos.x}
          cy={pos.y}
          r="8"
          fill="#222"
          stroke={index % 2 === 0 ? '#31E981' : '#AE8ABC'}
          stroke-width="3"
        />
      </g>
    ))}
  </svg>
  <Image src={avion} alt="Imagen de experiencia" class="w-30 h-30 scale-x-[-1] inline-block"/>
</div>
<ol class="space-y-4 px-8">
  {EXPERIENCE.map(({company, title, startDate, endDate, description}) => (
    <li>
      <ExperienceItem
        company={company}
        title={title}
        startDate={startDate}
        endDate={endDate}
        description={description}
      />
    </li>
  ))}
</ol>